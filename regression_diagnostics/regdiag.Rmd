---
title: "Regression Diagnostics"
author: "Kyubong Theodore Lee"
output:
  html_document: default
  md_document:
    variant: markdown_github
  pdf_document:
    latex_engine: xelatex
mainfont: D2Coding
---
***
##### 적합으로 회귀분석은 끝나지 않는다.
- 모형: 현재의 모형이 반응변수와 설명변수 간 관계를 제대로 반영하는지 조사해야한다. 설명변수들 중에서도 어느 변수가 중요한지 또는 불필요한 것들이 없는지 살펴보아야 한다.
- 자료: 잔차분석을 통해 오차항의 등분산성, 독립성, 정규성이 조사되어야한다. 특이값, 이상치의 확인 또한 필요하다.

### 부분 F검정
- 두 개 이상의 회귀계수들에 대한 개별적인 t검정을 동시에 하는 것은, 가설검정의 개념에서 부적절. 이에 대한 대안으로 개개의 계수에 대한 검정 대신 두 개의 가능한 모형을 비교(full vs reduced)<br/>
이 경우 F 분포를 이용한 검정을 하고, 다중검정에서의 유의수준 문제가 발생하지 않는다.
- 설명변수가 (p-1)개 있는 회귀모형에 대한 분산분석표의 F 검정에서 귀무가설 $H_{0}: β_{1} = β_{2} = ... = β_{p-1} = 0$ 을  
기각하는 경우, 모든 beta j가 0이 아니라는 것을 의지하지는 않는다.일부는 0이 되어 해당 설명변수는 반응변수와  
선형관계가 없음을 나타낼 수 있다. 
- (p - 1)개 설명변수로 이루어진 회귀모형 vs (p - r)개의 설명변수로 이루어진 회귀모형 비교:<br/>반응변수의 변동을 많이 설명해주는 설명변수를 모형에 포함시키면 SSE는 크게 감소, 기존의 모형에서 제거하면<br/> 크게 증가
- $H_{0}: β_{r} = β_{r+1} = ... = β_{p-1} = 0$ 이 옳다면, 이 설명변수들은 반응변수와 선형관계가 없다는 것을 의미하므로,<br/> Full model(p-1개 설명변수 가진 모형)에서 이 변수들을 제거한다하더라도 SSE는 크게 증가하지 않는다. 역으로 이들 설명변수를 회귀모형에서 제거했을 때, SSE의 크기가 많이 변하지 않으면 귀무가설이 옳은 것이고, 많이 증가하면(SSE가 많이 증가했다는 뜻은 제외시켰던 변수들이 반응변수의 변동을 잘 설명해주는 유효한 설명변수라는 뜻) 귀무가설이 옳지 않다고 볼 수 있다. 그러므로 SSE 또는 SSR의 값의 변화정도는 위의 가설에 대한 검정에서 중요한 역할을 한다.(SSR의 경우 상수항이 없는 모형에서는 접근 방식이 달라짐)
- 따라서 $SSE(Reduced) - SSE(Full)$의 크기를 조사하면 된다. 그리고 이를 $F_{0} =$ ${SSE(R) - SSE(F) / df_{R}-df_{F}} / {SSE(F)/df_{F}}$ 검정통계량 산출에 활용. 이 검정을 **부분 F 검정(partial F test)**
- '추가제곱합'은 완전모형에서 설명변수 $X_{j}$가 제외될 때 발생하는 제곱합의 차이로 해석할 수 있으며, 이를 $X_{j}$의 편제곱합(partial sum of squares)이라 부른다. 많은 경우 편제곱합의 크기로 설명변수의 중요도를 서열화하기도 한다.
- '순차제곱합(sequential sum of sqaures)는 영모델부터 설명변수들을 하나씩 추가시켜 나갈 때 증가하는 회귀제곱합의 크기. 순차제곱합들은 서로 독립이고, 각각 1의 자유도를 갖는다. 순차제곱합은 설명변수의 개수가 많은 경우 모형선택에 유용하게 사용됨. 반응변수에 대한 설명력이 높은 순서대로 설명변수들을 하나씩 모형에 포함시켜 나가면서 매 단계에서 부분 F 검정을 실시해, 추가제곱합의 증가량이 통계적으로 유의할때까지만 포함시켜 적절한 회귀모형을 찾을 수 있다.(step, direction = 'forward)
- R에서 순차제곱합과 편제곱합은 lm 객체에 `anova()`와 `drop1()`을 적용해 구한다.

```{r setup, result = 'hide'}
library(regbook)
```

```{r}
lm.fit <- lm(price ~ year + mileage + cc + automatic, usedcars)
anova(lm.fit)
```
- 순차제곱합 $SSR(F) = 2056608 + 135864 + 52409 + 175828 = 2420709$
```{r}
drop1(lm.fit, test = 'F')
```
- 위 결과는 편제곱합으로 설명변수 4개가 있는 full model에서 해당 설명변수를 제외할 때 감소하는 SSR의 크기 or 증가하는 SSE의 크기이다. 예를들어, cc를 제외한 경우 편제곱합은 37794
- 위의 경우 year의 편제곱합이 가장 크므로 price 설명에 제일 중요하다고 볼 수 있다.
- cc의 편제곱합 37794 검정통계량 $F_{0} = 3.697$ 이 값은 F 분포표의 값 F(0.05; 1, 25) = 4.242 보다 작으므로(p값이 0.05보다 크므로), 귀무가설 $H_{0}: β_{3} = 0$을 기각하지 못한다. 각 검정 결과는 출력결과 오른편에 있다.
- 참고로 $H_{0}: β_{3} = 0$에 대한 부분 F 검정통계량값 3.697은 완전모형에서의 beta3 hat에 대한 t값 1.9229의 제곱과 일치. 따라서 하나의 회귀계수에 대한 t 검정과 부분 F 검정이 일치함을 확인 가능
```{r}
summary(lm.fit)
```
- `anova()`로도 가설 $H_{0}: β_{3} = β_{4} = 0$ 검정 가능하다. 이는 full 모형과 이 두 변수가 빠진 모형을 비교하는 문제가 된다.
```{r}
mod_1 <- lm(price ~ year + mileage, usedcars)
mod_2 <- lm(price ~ year + mileage + cc + automatic, usedcars)
anova(mod_1, mod_2)
```
- F 통계량 값이 11.165이며, p 값이 0.0003이므로 귀무가설을 기각한다.
- SSE(R) - SSE(F) = 483775 - 255538 = 228237, 검정통계량은 (228237 / 2) / 10222 = 11.165
***
### 편회귀, 편상관계수
- 중회귀모형에서 회귀계수 $β_{j}$는 다른 설명변수들의 값이 고정되었을 때 설명변수 $X_{j}$의 값이 한 단위 증가함에 따른 반응변수의 '평균변화량'으로 해석. 그리고 최소제곱추정값 $\hat{β}_{j}$은 그 평균변화량의 추정값이다. 
- 그렇지만 일반적으로 중회귀모형에서는 반응변수 $Y$와 특정한 설명변수 $X_{j}$와의 관계가, 다른 설명변수들에 의해 영향을 받기 때문에 해석에 조심할 필요가 있음.
- 중고차 가격이 '연식(X1)'과 '주행거리(X2)'로 산정된다고 가정.
- 1차적으로 X1만으로 모형을 구축하면, $Y = \hat{Y}(X) + e(Y|X_{1})$. $e(Y|X_{1})$은 'X1에 의해 설명되지 않은 부분'이므로, X2가 추가된 풀 모형은 이 $e(Y|X_{1})$을 추가적으로 설명하는 것.
- X1과 X2가 어느 정도의 선형관계를 가지므로, X1에 대한 정보로 X2의 값을 어느 정도 예측할 수 있는데, 이는 X1만 포함된 회귀모형도 X2가 갖는 정보를 이미 어느 정도 포함하고 있다는 것을 의미. 그러므로 X2를 추가하는 경우, 모형의 설명에는 X1에 의해 알려지지 않는 X2의 정보만 추가로 사용된다고 할 수 있음. 즉, $X_{2} = \hat{X}_{2}(X_{1}) + e(X_{2}|X_{1})$. 'X1에 의해 이미 주어진 X2의 정보' + 'X1에 의해 주어지지 않은 X2의 정보'